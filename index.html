<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RAWZONE</title>
    <style>
      :root {
        color-scheme: dark;
        --bg: #0e0e10;
        --surface: #141416;
        --elev: #1a1b1e;
        --text: #e8e9ea;
        --muted: #a1a1aa;
        --accent: #8a8f98;
        --border: #252527;
        --shadow: 0 10px 30px rgba(0,0,0,0.35);
      }

      * { box-sizing: border-box; }

      html, body { height: 100%; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color: var(--text);
        background: radial-gradient(1200px 900px at 10% 0%, #111113, #0a0a0b) fixed;
      }

      .app {
        max-width: 960px;
        margin: 40px auto;
        padding: 24px;
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)), var(--surface);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
      }

      h2 { margin: 0 0 10px; font-weight: 600; letter-spacing: 0.2px; }
      p.helper { margin: 0 0 18px; color: var(--muted); font-size: 14px; }

      .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: stretch; margin-bottom: 14px; }

      /* Buttons */
      .btn {
        background: #232323;
        color: var(--text);
        border: 1px solid var(--border);
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        transition: transform .06s ease, background .2s ease;
        font-weight: 600;
      }
      .btn:hover { background: #2b2b2b; }
      .btn:active { transform: translateY(1px); }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }

      .btn.primary {
        background: linear-gradient(180deg, #3a3a3a, #2e2e2e);
        border-color: #2a2a2a;
      }
      .btn.primary:hover { background: linear-gradient(180deg, #424242, #343434); }

      /* File chooser */
      input[type="file"] { display: none; }
      .file-chooser { display: inline-flex; align-items: center; gap: 10px; }
      .file-name {
        color: var(--muted);
        font-size: 14px;
        min-width: 180px;
        max-width: 360px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Select */
      .select { position: relative; }
      .select select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: #1a1a1a;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 36px 10px 12px;
        font-weight: 600;
      }
      .select::after {
        content: '▾';
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
        pointer-events: none;
      }

      /* Log panel */
      #log {
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        background: #141414;
        padding: 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        min-height: 48px;
        color: var(--text);
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
      }

      .footer { color: var(--muted); font-size: 12px; margin-top: 10px; }
    </style>
  </head>
  <body>
    <div class="app">
      <h2>RAWZONE</h2>
      <p class="helper">Convert RAW photos to ACES and Log formats in your browser</p>
      <div class="row">
        <div class="file-chooser">
          <label for="file" class="btn">Choose RAW</label>
          <span id="fileName" class="file-name" aria-live="polite">No file selected</span>
          <input id="file" type="file" accept=".3fr,.ari,.arw,.bay,.cap,.crw,.cr2,.cr3,.dcs,.dcr,.dng,.drf,.eip,.erf,.fff,.gpr,.iiq,.k25,.kdc,.mdc,.mef,.mos,.mrw,.nef,.nrw,.obm,.orf,.pef,.ptx,.pxn,.r3d,.raf,.raw,.rw2,.rwl,.rwz,.sr2,.srf,.srw,.x3f">
        </div>
        <div class="select">
          <select id="pipeline">
            <option value="ap0-linear">ACES2065-1 (Linear APO)</option>
            <option value="acescct">ACEScct (ACEScct AP1)</option>
            <option value="arri-logc4">ARRI LogC4 AWG4</option>
          </select>
        </div>
        <div class="select">
          <select id="format" title="Output format">
            <option value="tiff">TIFF (16-bit)</option>
            <option value="j2c">JPEG 2000 Codestream (.j2c)</option>
          </select>
        </div>
        <button id="process" class="btn primary">Process</button>
      </div>
      <div id="log" aria-live="polite"></div>
    </div>

    <script type="module">
      // Exact requested settings: scene-referred linear XYZ, 16-bit, camera WB, no auto-bright
      const settings = {
        noAutoBright: true,
        noAutoScale: false,
        // Some builds use 'gamm', others 'gamma'. Provide both to be safe.
        gamm: [1, 0],
        outputColor: 6,
        outputBps: 16,
        useCameraWb: true,
        useCameraMatrix: 3,
      };

      const fileEl = document.getElementById('file');
      const pipelineEl = document.getElementById('pipeline');
      const formatEl = document.getElementById('format');
      const processBtn = document.getElementById('process');
      const logEl = document.getElementById('log');
      const fileNameEl = document.getElementById('fileName');

      function log(message) {
        logEl.textContent = message;
      }

      const worker = new Worker('./raw-worker.js', { type: 'module' });

      fileEl.addEventListener('change', function() {
        const f = fileEl.files && fileEl.files[0];
        fileNameEl.textContent = f ? f.name : 'No file selected';
      });

      async function processFile(file) {
        log('Reading file…');
        const buffer = await file.arrayBuffer();
        const pipeline = pipelineEl.value;
        const format = formatEl.value;

        log('Decoding RAW in worker…');
        const { out } = await new Promise((resolve, reject) => {
          function onMessage(e) {
            worker.removeEventListener('message', onMessage);
            const data = e.data || {};
            if (data.error) {
              reject(new Error(data.error));
              return;
            }
            resolve(data);
          }
          worker.addEventListener('message', onMessage);
          worker.postMessage({ cmd: 'process', bytes: buffer, settings, pipeline, format }, [buffer]);
        });

        const blob = new Blob([out], { type: format === 'j2c' ? 'application/octet-stream' : 'image/tiff' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const suffix = format === 'j2c'
                        ? (pipeline === 'acescct' ? '_acescct16.j2c'
                           : pipeline === 'arri-logc4' ? '_arri_logc4_16.j2c'
                           : '_ap0_linear16.j2c')
                        : (pipeline === 'acescct' ? '_acescct16.tiff'
                           : pipeline === 'arri-logc4' ? '_arri_logc4_16.tiff'
                           : '_ap0_linear16.tiff');
        a.download = (file.name.replace(/\.[^.]+$/, '') || 'output') + suffix;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        log('Done. Downloaded ' + (format === 'j2c' ? 'JPEG 2000' : 'TIFF') + '.');
      }

      processBtn.addEventListener('click', function() {
        const f = fileEl.files && fileEl.files[0];
        if (!f) {
          log('Please choose a RAW file.');
          return;
        }
        processBtn.disabled = true;
        processFile(f).catch(function(err) {
          console.error(err);
          log('Error: ' + (err && err.message ? err.message : String(err)));
        }).finally(function() {
          processBtn.disabled = false;
        });
      });
    </script>
  </body>
  </html>


