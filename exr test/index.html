<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EXR DWAA Test</title>
    <style>
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0f0f10; color: #e8e9ea; }
      .app { max-width: 980px; margin: 32px auto; padding: 24px; background: #161618; border: 1px solid #262629; border-radius: 12px; }
      .row { display:flex; gap:12px; align-items:center; }
      input[type=file] { display:none; }
      .btn { background:#232325; color:#e8e9ea; border:1px solid #2b2b2f; padding:8px 12px; border-radius:8px; cursor:pointer; }
      .btn.primary { background: linear-gradient(180deg, #b6ff00, #aaff00); color:#0c0c0d; border-color:#8acc00; }
      #log { margin-top: 12px; padding: 8px 12px; background:#121214; border:1px solid #262629; border-radius:8px; min-height: 24px; white-space: pre-wrap; }
    </style>
  </head>
  <body>
    <div class="app">
      <h2>EXR DWAA (OpenEXR Core WASM)</h2>
      <div class="row">
        <label for="file" class="btn">Choose 8K TIFF</label>
        <input id="file" type="file" accept=".tif,.tiff" />
        <div class="select"><select id="compression">
          <option value="8" selected>DWAA</option>
          <option value="9">DWAB</option>
          <option value="3">ZIP (rows)</option>
          <option value="2">ZIPS (per row)</option>
          <option value="4">PIZ</option>
          <option value="5">PXR24</option>
          <option value="6">B44</option>
          <option value="7">B44A</option>
          <option value="10">HTJ2K-256</option>
          <option value="11">HTJ2K-32</option>
          <option value="0">None</option>
        </select></div>
        <button id="go" class="btn primary">Convert to EXR</button>
        <label>DWA level <input id="dwa" type="number" min="1" max="250" step="1" value="45" style="width:80px;"/></label>
      </div>
      <div id="log"></div>
    </div>

    <script type="module">
      import { readTIFFRGBA16 } from './tiff16-reader.js';

      const fileEl = document.getElementById('file');
      const goBtn = document.getElementById('go');
      const compEl = document.getElementById('compression');
      const dwaEl = document.getElementById('dwa');
      const logEl = document.getElementById('log');

      function log(msg) { logEl.textContent = msg; }

      const worker = new Worker('./exr-worker.js', { type: 'module' });

      worker.onmessage = (e) => {
        const { type } = e.data || {};
        if (type === 'result') {
          const buffer = e.data.buffer;
          const blob = new Blob([buffer], { type: 'image/x-exr' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'output_dwaa.exr';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(a.href);
          log('Done. Downloaded output_dwaa.exr');
        } else if (type === 'error') {
          log('Error: ' + (e.data.error || 'unknown'));
        }
      };

      goBtn.addEventListener('click', async () => {
        const f = fileEl.files && fileEl.files[0];
        if (!f) { log('Choose a TIFF first'); return; }
        log('Reading TIFF…');
        const buf = await f.arrayBuffer();
        const { width, height, rgba16 } = await readTIFFRGBA16(buf);
        log('Encoding EXR (DWAA)…');
        const dwaLevel = parseInt(dwaEl.value || '45', 10) || 45;
        const compression = parseInt(compEl.value || '8', 10) || 8;
        // Transfer pixel buffer to worker
        worker.postMessage({ cmd: 'encode', rgba16: rgba16.buffer, width, height, dwaLevel, compression }, [rgba16.buffer]);
      });
    </script>
  </body>
  </html>


